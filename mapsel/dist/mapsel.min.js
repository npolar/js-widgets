var Mapsel=function(e){function t(e,t,n){if(t>n){var i=t;t=n,n=i}return Math.min(n,Math.max(t,e))}function n(e,t,i,a){var s=document.createElement(t);s.append=function(e,t,i){return n(s,e,t,i)};for(var l in i)s.setAttribute(l,i[l]);return void 0!==a&&(s.innerHTML=a),e.appendChild(s),s}e=e||{};var i=this;this.api=e.api||"google",this.background=e.background||"#e3e3e3",this.container=e.container||null,this.closeable=e.closeable===!1?!1:!0,this.element=document.createElement("div"),this.elements={},this.events={},this.font={size:"14px"},this.height=e.height||250,this.instance=Mapsel.instances++,this.language=e.language||"en",this.latitude=t("number"==typeof e.latitude?e.latitude:65,-90,90),this.longitude=t("number"==typeof e.longitude?e.longitude:0,-90,90),this.opacity=t("number"==typeof e.opacity?e.opacity:1,0,1),this.precision=t("number"==typeof e.precision?e.precision:2,0,8),this.radius=Math.max(Math.round(e.radius||0),0)||null,this.visible=e.visible===!1?!1:!0,this.width=e.width||200,this.x=e.x||0,this.y=e.y||0,this.element.append=function(e,t,a){return n(i.element,e,t,a)};for(var a=this.precision?"0.":"1",s=0;s<this.precision;++s)a+=s==this.precision-1?1:0;this.elements.titleBar=this.element.append("header"),this.elements.mapContainer=this.element.append("div",{id:"mapsel_map_"+this.instance}),this.elements.fieldset=this.element.append("fieldset"),this.closeable&&(this.elements.closeButton=this.elements.titleBar.append("a",{title:Mapsel.i18n[this.language].CLOSE},"X"),this.elements.closeButton.addEventListener("click",function(){i.hide()})),this.elements.latLabel=this.elements.fieldset.append("label",{"for":"mapsel_lat_"+this.instance},Mapsel.i18n[this.language].LATITUDE),this.elements.latInput=this.elements.fieldset.append("input",{id:"mapsel_lat_"+this.instance,type:"number",title:Mapsel.i18n[this.language].LATITUDE,min:-90,max:90,step:a,value:this.latitude.toFixed(this.precision)}),this.elements.lngLabel=this.elements.fieldset.append("label",{"for":"mapsel_lng_"+this.instance},Mapsel.i18n[this.language].LONGITUDE),this.elements.lngInput=this.elements.fieldset.append("input",{id:"mapsel_lng_"+this.instance,type:"number",title:Mapsel.i18n[this.language].LONGITUDE,min:-180,max:180,step:a,value:this.longitude.toFixed(this.precision)}),null!==this.radius&&(this.elements.radLabel=this.elements.fieldset.append("label",{"for":"mapsel_rad_"+this.instance},Mapsel.i18n[this.language].RADIUS),this.elements.radInput=this.elements.fieldset.append("input",{id:"mapsel_rad_"+this.instance,type:"number",title:Mapsel.i18n[this.language].RADIUS,step:1,value:this.radius})),this.element.className="mapsel",this.element.style.position=this.container?"relative":"absolute",this.element.style.background=this.background,this.element.style.fontSize=this.font.size,this.element.style.opacity=this.opacity,this.container?this.container.appendChild(this.element):document.body.appendChild(this.element),this.move(this.x,this.y),this.resize(this.width,this.height),this.visible?this.init(this.api):this.hide()};Mapsel.api={},Mapsel.instances=0,Mapsel.prototype={on:function(e,t){"function"==typeof t?this.events[e]=t:this.events[e]&&delete this.events[e]},hide:function(){this.element&&(this.element.style.display="none"),this.visible=!1},focus:function(e){if(this.elements)switch(e){case"lat":case"latitude":this.elements.latInput&&this.elements.latInput.focus();break;case"lng":case"longitude":this.elements.lngInput&&this.elements.lngInput.focus();break;case"rad":case"radius":this.elements.radInput&&this.elements.radInput.focus()}},init:function(e){var t=this;for(var n in Mapsel.api)if(e.toLowerCase()==n.toLowerCase())return this.api=new Mapsel.api[n](t),!0;return console.error("Unsupported map API: "+e),!1},move:function(e,t,n){this.element&&(this.element.style.left=(n?this.x+=e:this.x=Math.max(e,0))+"px",this.element.style.top=(n?this.y+=t:this.y=Math.max(t,0))+"px")},resize:function(e,t,n){this.width=Math.max(n?this.width+=e:e,200),this.height=Math.max(n?this.height+=t:t,200);var i=0,a=document.createElement("span"),s=["LATITUDE","LONGITUDE","RADIUS"];a.style.fontSize=this.font.size,a.style.visibility="hidden",document.body.appendChild(a);for(var l in Mapsel.i18n[this.language])-1!=s.indexOf(l)&&(a.innerHTML=Mapsel.i18n[this.language][l],i=Math.max(i,a.offsetWidth));document.body.removeChild(a);var r=Math.ceil((i+15)/this.width*100),o=r+"%",d=100-r+"%",p=this.height,u=window.getComputedStyle(this.element,null);p-=parseInt(u.borderTopWidth)+parseInt(u.borderBottomWidth),p-=parseInt(u.paddingTop)+parseInt(u.paddingBottom),p-=this.elements.titleBar.offsetHeight,p-=this.elements.fieldset.offsetHeight,this.elements.latLabel.style.width=o,this.elements.latInput.style.width=d,this.elements.lngLabel.style.width=o,this.elements.lngInput.style.width=d,null!==this.radius&&(this.elements.radLabel.style.width=o,this.elements.radInput.style.width=d),this.element.style.width=this.width+"px",this.element.style.height=this.height+"px",this.elements.mapContainer.style.height=p+"px"},show:function(){this.element&&(this.element.style.display="block","object"==typeof this.api?this.api.center(this.latitude,this.longitude):this.init(this.api)),this.visible=!0}},Mapsel.i18n={en:{CLOSE:"Click to close",LATITUDE:"Latitude",LONGITUDE:"Longitude",RADIUS:"Radius"},ja:{CLOSE:"閉じます",LATITUDE:"緯度",LONGITUDE:"経度",RADIUS:"半径"},nb:{CLOSE:"Klikk for å lukke",LATITUDE:"Breddegrad",LONGITUDE:"Lengdegrad",RADIUS:"Radius"},nn:{CLOSE:"Klikk for å stengje",LATITUDE:"Breiddegrad",LONGITUDE:"Lengdegrad",RADIUS:"Radius"},yue:{CLOSE:"點擊關閉",LATITUDE:"緯度",LONGITUDE:"經度",RADIUS:"半徑"},zh:{CLOSE:"点击关闭",LATITUDE:"纬度",LONGITUDE:"经度",RADIUS:"半径"}},function(){var e=document.head||document.getElementsByTagName("head")[0],t=document.createElement("style"),n={".mapsel":["border: 1px solid #aaa","border-radius: 5px","box-shadow: 0 0 2px 0 #aaa","box-sizing: border-box","font-family: sans-serif","font-size: 0","padding: 5px","text-align: right"],".mapsel *":["border: 0","box-sizing: border-box","font-weight: normal","line-height: normal","margin: 0","padding: 0"],".mapsel header a":["color: #aaa","cursor: pointer","display: inline-block","font-size: inherit","font-weight: bold","margin: 0 2px 5px 0","text-decoration: none","text-shadow: 0 0 2px #ccc"],".mapsel header a:hover":["text-shadow: 0 0 1px #333"],".mapsel > div":["border: 1px solid #aaa","border-radius: 5px","display: block","width: 100%"],".mapsel fieldset label":["display: inline-block","font-size: inherit","padding-right: 5px","text-align: right","width: 40%"],".mapsel fieldset input":["border: 1px solid #aaa","border-radius: 5px","box-shadow: 0 0 2px 0 #aaa inset","font-size: inherit","margin-top: 5px","padding: 2px 5px","width: 60%"],".mapsel-icon":["background: #fff","border: 1px solid #333","border-radius: 2px","box-shadow: 0 0 3px 0 #3c3c3c","cursor: pointer"],".mapsel-icon:hover":["background: #ccc","box-shadow: 0 0 3px 0 #393939"],".mapsel-icon-move":["border-radius: 5px","cursor: move"],".mapsel-icon-resize-ns":["cursor: ns-resize"],".mapsel-icon-resize-ew":["cursor: ew-resize"],".mapsel-icon-resize-ne":["cursor: ne-resize"],".mapsel-icon-resize-nw":["cursor: nw-resize"],".mapsel-icon-resize-se":["cursor: se-resize"],".mapsel-icon-resize-sw":["cursor: sw-resize"]};t.type="text/css";for(var i in n){var a=i+" {";for(var s in n[i])a+=n[i][s]+";";t.appendChild(document.createTextNode(a+"}"))}e.appendChild(t)}(),function(){window.google&&window.google.maps&&(Mapsel.api.Google=function(e){var t=this;this.map=null,this.marker=null,"object"==typeof e&&(t.map=new google.maps.Map(e.elements.mapContainer,{center:{lat:e.latitude,lng:e.longitude},disableDoubleClickZoom:!0,mapTypeId:google.maps.MapTypeId.TERRAIN,streetViewControl:!1,zoom:2}),e.radius?(t.marker=new google.maps.Circle({center:t.map.getCenter(),draggable:!0,editable:!0,map:t.map,radius:e.radius}),google.maps.event.addListener(t.map,"dblclick",function(e){t.marker.setCenter(e.latLng)}),google.maps.event.addListener(t.marker,"center_changed",function(){var n=t.marker.getCenter(),i=Number(n.lat().toFixed(e.precision)),a=Number(n.lng().toFixed(e.precision));i!=e.latitude&&(e.elements.latInput.value=e.latitude=i,"function"==typeof e.events.latitude&&e.events.latitude(i)),a!=e.longitude&&(e.elements.lngInput.value=e.longitude=a,"function"==typeof e.events.longitude&&e.events.longitude(a))}),google.maps.event.addListener(t.marker,"radius_changed",function(){e.elements.radInput.value=e.radius=Math.round(t.marker.getRadius()),"function"==typeof e.events.radius&&e.events.radius(e.radius)}),e.elements.latInput.addEventListener("change",function(n){t.marker.setCenter({lat:Number(n.target.value),lng:e.longitude}),t.map.setCenter(t.marker.getCenter())}),e.elements.lngInput.addEventListener("change",function(n){t.marker.setCenter({lat:e.latitude,lng:Number(n.target.value)}),t.map.setCenter(t.marker.getCenter())}),e.elements.radInput.addEventListener("change",function(n){t.marker.setRadius(e.radius=Number(n.target.value))})):(t.marker=new google.maps.Marker({position:t.map.getCenter(),draggable:!0,map:t.map}),google.maps.event.addListener(t.map,"dblclick",function(e){t.marker.setPosition(e.latLng)}),google.maps.event.addListener(t.marker,"position_changed",function(){var n=t.marker.getPosition(),i=Number(n.lat().toFixed(e.precision)),a=Number(n.lng().toFixed(e.precision));i!=e.latitude&&(e.elements.latInput.value=e.latitude=i,"function"==typeof e.events.latitude&&e.events.latitude(i)),a!=e.longitude&&(e.elements.lngInput.value=e.longitude=a,"function"==typeof e.events.longitude&&e.events.longitude(a))}),e.elements.latInput.addEventListener("change",function(n){t.marker.setPosition({lat:Number(n.target.value),lng:e.longitude}),t.map.setCenter(t.marker.getPosition())}),e.elements.lngInput.addEventListener("change",function(n){t.marker.setPosition({lat:e.latitude,lng:Number(n.target.value)}),t.map.setCenter(t.marker.getPosition())})))},Mapsel.api.Google.prototype={center:function(e,t){this.map&&this.map.setCenter({lat:e,lng:t})}})}(),function(){window.L&&window.L.map&&(L.MapselCircle=L.Circle.extend({options:{color:"#000",draggable:!1,editable:!1,weight:2},_initMarkers:function(){var e=this.getLatLng();this._markers={},this._layerGroup=new L.LayerGroup,this.options.draggable&&(this._markers.move=new L.Marker(e,{draggable:!0,icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"mapsel-icon mapsel-icon-move"})}).on("drag",this._onMove,this),this._layerGroup.addLayer(this._markers.move)),this.options.editable&&(this._markers.resize=new L.Marker(e,{draggable:!0,icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"mapsel-icon mapsel-icon-resize-ew"})}).on("drag",this._onResize,this),this._layerGroup.addLayer(this._markers.resize)),this._updateMarkers(),this._map.addLayer(this._layerGroup)},_updateMarkers:function(){if(this._markers){var e=this.getBounds(),t=e.getCenter(),n=e.getNorthEast();this._markers.move&&this._markers.move.setLatLng(t),this._markers.resize&&this._markers.resize.setLatLng(new L.LatLng(t.lat,n.lng))}},_onMove:function(e){var t=e.target;this.setLatLng(t.getLatLng()),this.fire("center_changed")},_onResize:function(e){var t=e.target,n=this.getLatLng(),i=n.distanceTo(t._latlng);this.setRadius(i);var a=this.getBounds().getNorthEast();t.setLatLng(new L.LatLng(n.lat,a.lng)),this.fire("radius_changed")},onAdd:function(e){L.Path.prototype.onAdd.call(this,e),this._initMarkers()},onRemove:function(e){L.Path.prototype.onRemove.call(this,e),this._map&&this._layerGroup&&this._map.removeLayer(this._layerGroup),delete this._markers,delete this._layerGroup},setLatLng:function(e){L.Circle.prototype.setLatLng.call(this,e),this._updateMarkers()},setRadius:function(e){L.Circle.prototype.setRadius.call(this,e),this._updateMarkers()}}),Mapsel.api.Leaflet=function(e){function t(e){if(e&&e.lat&&e.lng){for(var t=new L.LatLng(e.lat,e.lng);t.lat>90;)t.lat=-(180-t.lat);for(;t.lat<-90;)t.lat=t.lat+180;for(;t.lng>180;)t.lng=-(360-t.lng);for(;t.lng<-180;)t.lng=t.lng+360;return t}return e}var n=this;this.map=null,this.marker=null,"object"==typeof e&&(n.map=new L.Map(e.elements.mapContainer,{center:{lat:e.latitude,lng:e.longitude},doubleClickZoom:!1,zoom:2}),L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'<a href="http://osm.org/copyright">OpenStreetMap</a>',minZoom:0,maxZoom:16}).addTo(n.map),e.radius?(n.marker=new L.MapselCircle(n.map.getCenter(),e.radius,{draggable:!0,editable:!0}).addTo(n.map),n.map.on("dblclick",function(t){n.marker.setLatLng(t.latlng),e.latitude=e.elements.latInput.value=t.latlng.lat.toFixed(e.precision),e.longitude=e.elements.lngInput.value=t.latlng.lng.toFixed(e.precision)}),n.marker.on("center_changed",function(){var i=t(n.marker.getLatLng()),a=Number(i.lat.toFixed(e.precision)),s=Number(i.lng.toFixed(e.precision));a!=e.latitude&&(e.elements.latInput.value=e.latitude=a,"function"==typeof e.events.latitude&&e.events.latitude(a)),s!=e.longitude&&(e.elements.lngInput.value=e.longitude=s,"function"==typeof e.events.longitude&&e.events.longitude(s))}),n.marker.on("radius_changed",function(){e.elements.radInput.value=e.radius=Math.round(n.marker.getRadius()),"function"==typeof e.events.radius&&e.events.radius(e.radius)}),e.elements.latInput.addEventListener("change",function(t){n.marker.setLatLng({lat:e.latitude=Number(t.target.value),lng:e.longitude}),n.map.setView(n.marker.getLatLng())}),e.elements.lngInput.addEventListener("change",function(t){n.marker.setLatLng({lat:e.latitude,lng:e.longitude=Number(t.target.value)}),n.map.setView(n.marker.getLatLng())}),e.elements.radInput.addEventListener("change",function(t){n.marker.setRadius(e.radius=Number(t.target.value))})):(n.marker=new L.Marker(n.map.getCenter(),{draggable:!0}).addTo(n.map),n.map.on("dblclick",function(e){n.marker.setLatLng(e.latlng)}),n.marker.on("move",function(n){var i=t(n.latlng),a=Number(i.lat.toFixed(e.precision)),s=Number(i.lng.toFixed(e.precision));a!=e.latitude&&(e.elements.latInput.value=e.latitude=a,"function"==typeof e.events.latitude&&e.events.latitude(a)),s!=e.longitude&&(e.elements.lngInput.value=e.longitude=s,"function"==typeof e.events.longitude&&e.events.longitude(s))}),e.elements.latInput.addEventListener("change",function(t){n.marker.setLatLng({lat:Number(t.target.value),lng:e.longitude}),n.map.setView(n.marker.getLatLng())}),e.elements.lngInput.addEventListener("change",function(t){n.marker.setLatLng({lat:e.latitude,lng:Number(t.target.value)}),n.map.setView(n.marker.getLatLng())})))},Mapsel.api.Leaflet.prototype={center:function(e,t){this.map&&this.map.setView({lat:e,lng:t})}})}();